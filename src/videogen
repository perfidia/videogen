#!/usr/bin/env python

from videogenlib import *
import os
import sys

def main():
    vidgen_parser = VideoGenOptionParser()
    options = vidgen_parser.get_options()
    
    if len(sys.argv) < 2:
        vidgen_parser.print_help()
        return
    
    if options.conf == None:
        print "use -c [file] or --conf=[file], help:"
        vidgen_parser.print_help()
        return
    
    trees = ShotsTrees(options)
    (shots, configuration_node) = trees.create()
    
    for shot in shots:
        visitor = FFMpegVisitor()
        shot.accept(visitor)
        command = visitor.get_command()
        print command
        os.system(command)
        
    if shots:
        visitor = FFMpegVisitor()
        sequence = ProgramNode(options.encoder)
        sequence.overwrite = options.overwrite
        if len(shots) > 1:
            concat = ConcatNode()
            sequence.add_child(concat)
        
        outfn = OutputFileNode(options.output)
        sequence.add_child(outfn)
        
        mainconf = ConfigurationNode(None, None, None, -1,
                                     configuration_node.video_codec, 
                                     configuration_node.audio_codec)
        
        outfn.add_child(mainconf)
        
        i = 0
        
        for shot in shots:
            i = i + 1
            sequence.add_child(InputFileNode(options.tmp + options.attach + str(i)+".avi", TYPE_VIDEO))
            
        sequence.accept(visitor)
        command = visitor.get_command()
        print command
        os.system(command)
        subs = SoftSubtitles(options.output, options.softsubtitles)
        subs.add_subtitles()
        
    return

if __name__ == "__main__":
    main()
    